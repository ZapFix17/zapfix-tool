<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZAPFIX Tools - Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: #00D9FF;
      letter-spacing: 1px;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .upload-btn, .logout-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .upload-btn {
      background: #00D9FF;
      color: #0a0e27;
    }

    .upload-btn:hover {
      background: #00b8cc;
      transform: translateY(-2px);
    }

    .logout-btn {
      background: #ff6464;
      color: #fff;
    }

    .logout-btn:hover {
      background: #ff4444;
      transform: translateY(-2px);
    }

    .panel-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: #00D9FF;
      margin-bottom: 2rem;
    }

    .tools-list {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .tool-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(0, 217, 255, 0.3);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }

    .tool-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: #00D9FF;
    }

    .tool-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .tool-name {
      font-size: 1.3rem;
...(truncated 11969 characters)...
  </style>
</head>
<body>
  <header>
    <div class="logo">ZAPFIX</div>
    <div class="header-actions">
      <a href="adminupload.html" class="upload-btn">Upload New Tool</a>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <h1 class="panel-title">Admin Panel - Manage Tools</h1>
  <div id="errorMessage" class="error-message"></div>
  <div class="tools-list" id="toolsList">
    <div class="loading">Loading tools...</div>
  </div>

  <script>
    const BACKEND_URL = '';  // Empty for Render (same domain)

    async function loadTools() {
      try {
        const response = await fetch(`${BACKEND_URL}/api/admin/tools`, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
          }
        });

        if (!response.ok) throw new Error('Failed to load tools');
        const tools = await response.json();
        renderTools(tools);
      } catch (err) {
        showError('Failed to load tools. Please login again.');
        console.error(err);
      }
    }

    function renderTools(tools) {
      const container = document.getElementById('toolsList');
      if (tools.length === 0) {
        container.innerHTML = '<div class="no-tools">No tools uploaded yet. Use the upload button to add new tools.</div>';
        return;
      }

      container.innerHTML = tools.map(tool => `
        <div class="tool-item" id="tool-${tool._id}">
          <div class="tool-header">
            <h3 class="tool-name">${tool.name}</h3>
            <div class="tool-actions">
              <button class="update-btn" onclick="updateTool('${tool._id}')">Update</button>
              <button class="delete-btn" onclick="deleteTool('${tool._id}')">Delete</button>
            </div>
          </div>

          <div class="form-group">
            <label for="editName-${tool._id}">Name</label>
            <input type="text" id="editName-${tool._id}" value="${tool.name}">
          </div>

          <div class="form-group">
            <label for="editDesc-${tool._id}">Description</label>
            <textarea id="editDesc-${tool._id}" rows="3">${tool.description}</textarea>
          </div>

          <div class="form-group">
            <label for="editIcon-${tool._id}">New Icon (optional)</label>
            <input type="file" id="editIcon-${tool._id}" accept="image/*">
          </div>

          <div class="form-group">
            <label for="editThumb-${tool._id}">New Thumbnail (optional)</label>
            <input type="file" id="editThumb-${tool._id}" accept="image/*">
          </div>

          <div class="form-group">
            <label for="editFile-${tool._id}">New File (optional)</label>
            <input type="file" id="editFile-${tool._id}">
          </div>

          <div class="comments-section">
            <h4>Comments (${tool.comments?.length || 0})</h4>
            <div class="comments-list">
              ${renderComments(tool.comments, tool._id)}
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderComments(comments, toolId) {
      if (!comments || comments.length === 0) {
        return '<p>No comments yet</p>';
      }

      return comments.map(comment => `
        <div class="comment" id="comment-${comment._id}">
          <div class="comment-header">
            <span class="comment-author">${comment.name || 'Anonymous'}</span>
            <button class="delete-comment-btn" onclick="deleteComment('${toolId}', '${comment._id}')">Delete</button>
          </div>
          <p class="comment-text">${comment.text}</p>
          <p class="comment-time">${new Date(comment.createdAt).toLocaleString()}</p>
        </div>
      `).join('');
    }

    async function updateTool(toolId) {
      const name = document.getElementById(`editName-${toolId}`).value;
      const description = document.getElementById(`editDesc-${toolId}`).value;
      const iconFile = document.getElementById(`editIcon-${toolId}`).files[0];
      const thumbFile = document.getElementById(`editThumb-${toolId}`).files[0];
      const fileFile = document.getElementById(`editFile-${toolId}`).files[0];

      const formData = new FormData();
      formData.append('name', name);
      formData.append('description', description);
      if (iconFile) formData.append('icon', iconFile);
      if (thumbFile) formData.append('thumbnail', thumbFile);
      if (fileFile) formData.append('file', fileFile);

      try {
        const response = await fetch(`${BACKEND_URL}/api/admin/tool/${toolId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
          },
          body: formData
        });

        if (!response.ok) throw new Error('Failed to update tool');
        loadTools();
      } catch (err) {
        showError(err.message);
      }
    }

    async function deleteTool(toolId) {
      if (!confirm('Are you sure you want to delete this tool?')) return;

      try {
        const response = await fetch(`${BACKEND_URL}/api/admin/tool/${toolId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
          }
        });

        if (!response.ok) throw new Error('Failed to delete tool');
        loadTools();
      } catch (err) {
        showError(err.message);
      }
    }

    async function deleteComment(toolId, commentId) {
      if (!confirm('Are you sure you want to delete this comment?')) return;

      try {
        const response = await fetch(`${BACKEND_URL}/api/admin/tool/${toolId}/comment/${commentId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
          }
        });

        if (!response.ok) throw new Error('Failed to delete comment');
        loadTools();
      } catch (err) {
        showError(err.message);
      }
    }

    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    function logout() {
      localStorage.removeItem('adminToken');
      window.location.href = 'logindownload.html';
    }

    loadTools();
  </script>
</body>
</html>
